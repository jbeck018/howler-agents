name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  python:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: howler
          POSTGRES_PASSWORD: howler
          POSTGRES_DB: howler_agents_test
        ports: ["5432:5432"]
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - run: uv sync --all-packages
      - name: Lint
        run: |
          uv run ruff check packages/
          uv run ruff format --check packages/
      - name: Type check
        run: uv run mypy
      - name: Test
        run: uv run pytest packages/ -v --tb=short
        env:
          DATABASE_URL: postgresql+asyncpg://howler:howler@localhost:5432/howler_agents_test

  node:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install
      - name: Lint
        run: pnpm --filter howler-agents-ui --filter @howler-agents/sdk run lint
      - name: Type check
        run: pnpm -r run typecheck
      - name: Test
        run: pnpm -r run test

  proto:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: bufbuild/buf-setup-action@v1
      - name: Lint proto
        run: buf lint proto/
      - name: Generate proto
        run: |
          if command -v buf &> /dev/null; then
            buf generate proto/
          fi
      - name: Check type drift
        run: |
          if command -v buf &> /dev/null; then
            buf generate proto/
            git diff --exit-code
          fi
      - name: Check breaking changes
        run: buf breaking proto/ --against 'https://github.com/${{ github.repository }}.git#branch=main,subdir=proto'
        continue-on-error: true
