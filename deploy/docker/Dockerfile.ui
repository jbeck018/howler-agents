FROM node:22-slim AS builder

RUN corepack enable pnpm

WORKDIR /app
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml* ./
COPY packages/howler-agents-ui/package.json packages/howler-agents-ui/
COPY packages/howler-agents-ts/package.json packages/howler-agents-ts/
COPY packages/howler-agents-docs/package.json packages/howler-agents-docs/

RUN pnpm install --frozen-lockfile || pnpm install

COPY packages/howler-agents-ui packages/howler-agents-ui
COPY packages/howler-agents-ts packages/howler-agents-ts

RUN pnpm --filter howler-agents-ui run build

FROM nginx:alpine AS runtime
COPY --from=builder /app/packages/howler-agents-ui/dist /usr/share/nginx/html
COPY <<'EOF' /etc/nginx/conf.d/default.conf
server {
    listen 3000;
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://howler-agents-service:8080;
    }

    location /health {
        proxy_pass http://howler-agents-service:8080;
    }
}
EOF

EXPOSE 3000
CMD ["nginx", "-g", "daemon off;"]
